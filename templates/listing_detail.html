{% extends "base.html" %}

{% block title %}{{ listing.title }} - Listing Details{% endblock %}

{% block content %}
<a href="{{ url_for('listings_page') }}" class="back-link">â† Back to all listings</a>

<div class="card">
    <h1>{{ listing.title }}</h1>
    
    <div class="metadata">
        <div class="meta-item">
            <div class="meta-label">Listing ID</div>
            <div class="meta-value">#{{ listing.id }}</div>
        </div>
        <div class="meta-item">
            <div class="meta-label">Status</div>
            <div id="statuswrap" class="meta-value">
                <input id="statusfield" type="text" value="{{ listing.status }}" readonly data-original="{{ listing.status }}" class="editable-field">
            </div>
        </div>
        <div class="meta-item">
            <div class="meta-label">Condition</div>
            <div class="meta-value">
                <input id="conditionfield" type="text" value="{{ listing.condition }}" readonly data-original="{{ listing.condition }}" class="editable-field">
            </div>
        </div>
        <div class="meta-item">
            <div class="meta-label">JIRA Issue</div>
            <div class="meta-value">
                <a href="{{ jira_site_url }}/browse/{{ listing.jira_issue_key }}" 
                   target="_blank" class="badge badge-jira">{{ listing.jira_issue_key }}</a>
            </div>
        </div>
    </div>
    
    <div class="price-section">
        <div class="price-main">{{ listing.suggested_price|currency }}</div>
        <div class="price-range">
            Price range: {{ listing.price_min|currency }} - {{ listing.price_max|currency }}
        </div>
    </div>

    <div class="research-actions">
    {% if listing.status == 'draft' %}
    <button onclick="startResearch({{ listing.id }})" class="btn btn-primary btn-lg" id="research-btn">
        ğŸ” Start Research
    </button>
    <span id="research-status" class="text-muted"></span>
    {% elif listing.status == 'researching' %}
    <div class="alert alert-info">
        <strong>ğŸ”„ Research in progress...</strong>
        <button onclick="location.reload()" class="btn btn-sm btn-secondary">Refresh Page</button>
    </div>
    {% elif listing.status == 'ready' %}
    <div class="alert alert-success">
        âœ… Research completed! Listing is ready.
    </div>
    {% endif %}
    </div>
    
    <div class="meta-item">
        <div class="meta-label">Measurements</div>
        <div class="meta-value">
            <input id="measurementsfield" class="editable-field" type="text" value="{{ listing.measurements or '' }}" readonly data-original="{{ listing.measurements or '' }}">
        </div>
    </div>
    
    <h2 class="section-title">Description</h2>
    <div class="description">
        <textarea id="descriptionfield" class="editable-field" readonly data-original="{{ listing.description or '' }}">{{ listing.description or 'No description available' }}</textarea>
    </div>
    
    {% if listing.images %}

<h2 class="section-title">My Images ({{ listing.images|length }})</h2>
<div class="my-images-grid">
    {% for img_path in listing.images %}
    <div class="my-image-card">
        <div class="my-image-preview" onclick="openImageModal('{{ url_for('static', filename=img_path) }}')">
            <img src="{{ url_for('static', filename=img_path) }}"
                 alt="Listing image {{ loop.index }}"
                 loading="lazy">
            <div class="my-image-overlay">
                <span class="my-image-zoom-icon">ğŸ”</span>
            </div>
        </div>
        <div class="my-image-actions">
            <button onclick="copyImageUrl('{{ url_for('static', filename=img_path, _external=True) }}')"
                    class="btn btn-sm btn-outline-secondary"
                    title="Copy image URL">
                ğŸ“‹ Copy URL
            </button>
            <a href="{{ url_for('static', filename=img_path) }}"
               target="_blank"
               class="btn btn-sm btn-outline-secondary"
               title="Open in new tab">
                ğŸ”— Full Size
            </a>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Image Modal/Lightbox -->
<div id="imageModal" class="image-modal" onclick="closeImageModal()">
    <span class="image-modal-close">&times;</span>
    <img class="image-modal-content" id="modalImage">
    <div class="image-modal-caption" id="modalCaption"></div>
    <div class="image-modal-actions">
        <button onclick="event.stopPropagation(); downloadModalImage()" class="btn btn-primary">
            â¬‡ï¸ Download
        </button>
        <button onclick="event.stopPropagation(); copyModalImageUrl()" class="btn btn-secondary">
            ğŸ“‹ Copy URL
        </button>
    </div>
</div>

    {% endif %}
    
    {% if listing.sources %}

<h2 class="section-title">
    Research Sources ({{ listing.sources|length }})
    {% if listing.sources|length > 0 %}
    <button onclick="deleteAllSources({{ listing.id }})" class="btn btn-sm btn-danger" style="float: right;">
        ğŸ—‘ï¸ Delete All Sources
    </button>
    {% endif %}
</h2>
<div class="sources-grid">
    {% for source in listing.sources %}
    <div class="source-card" id="source-{{ source.id }}">
        {% if source.image_url %}
        <div class="source-image">
            <img src="{{ source.image_url }}" 
                 alt="{{ source.title }}" 
                 loading="lazy"
                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'200\' viewBox=\'0 0 300 200\'%3E%3Crect fill=\'%23f0f0f0\' width=\'300\' height=\'200\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' font-family=\'monospace\' font-size=\'16\' fill=\'%23999\'%3ENo Image%3C/text%3E%3C/svg%3E';">
            <button onclick="deleteSource({{ listing.id }}, {{ source.id }})" 
                    class="source-delete-btn" 
                    title="Delete this source">
                âœ•
            </button>
        </div>
        {% else %}
        <div class="source-image source-no-image">
            <span>ğŸ“· No Image</span>
            <button onclick="deleteSource({{ listing.id }}, {{ source.id }})" 
                    class="source-delete-btn" 
                    title="Delete this source">
                âœ•
            </button>
        </div>
        {% endif %}
        
        <div class="source-content">
            <h4 class="source-title">
                <a href="{{ source.url }}" target="_blank" rel="noopener">
                    {{ source.title }}
                </a>
            </h4>
            
            <div class="source-meta">
                {% if source.price %}
                <div class="source-price">${{ "%.2f"|format(source.price) }}</div>
                {% else %}
                <div class="source-price text-muted">Price not listed</div>
                {% endif %}
                
                {% if source.location %}
                <div class="source-location">ğŸ“ {{ source.location }}</div>
                {% endif %}
                
                {% if source.condition %}
                <div class="source-condition">
                    <span class="badge badge-secondary">{{ source.condition }}</span>
                </div>
                {% endif %}
            </div>
            
            {% if source.measurements %}
            <div class="source-measurements">
                ğŸ“ {{ source.measurements }}
            </div>
            {% endif %}
            
            {% if source.description %}
            <div class="source-description">
                {{ source.description[:200] }}{% if source.description|length > 200 %}...{% endif %}
            </div>
            {% endif %}
            
            <div class="source-footer">
                <small class="text-muted">
                    Posted: {{ source.posted_date or 'Unknown' }}
                </small>
                <a href="{{ source.url }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-primary">
                    View on Craigslist â†’
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <p>No research sources found yet.</p>
</div>

    {% endif %}
    
    <h2 class="section-title">Timeline</h2>
    <div class="metadata">
        <div class="meta-item">
            <div class="meta-label">Created</div>
            <div class="meta-value">{{ listing.created_at|datetime }}</div>
        </div>
        <div class="meta-item">
            <div class="meta-label">Last Updated</div>
            <div class="meta-value">{{ listing.updated_at|datetime }}</div>
        </div>
        {% if listing.listed_at %}
        <div class="meta-item">
            <div class="meta-label">Listed</div>
            <div class="meta-value">{{ listing.listed_at|datetime }}</div>
        </div>
        {% endif %}
        {% if listing.sold_at %}
        <div class="meta-item">
            <div class="meta-label">Sold</div>
            <div class="meta-value">{{ listing.sold_at|datetime }}</div>
        </div>
        {% endif %}
    </div>
</div>

<style>
.editable-field {
    transition: background-color 0.2s;
}

.editable-field.modified {
    background-color: #ffeb3b !important;
}

.editable-field[readonly] {
    background-color: #f5f5f5;
    color: #666;
    cursor: pointer;
    border: 1px solid #ddd;
}

.editable-field[readonly]:hover {
    background-color: #ececec;
}

#descriptionfield {
    width: 100%;
    min-height: 150px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: inherit;
    font-size: inherit;
    resize: vertical;
}

#statusfield, #conditionfield, #measurementsfield {
    width: 100%;
    padding: 5px;
    border-radius: 4px;
}
</style>

<script>
// Image Modal Functions
let currentImageUrl = '';

function openImageModal(imageUrl) {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    const caption = document.getElementById('modalCaption');
    
    currentImageUrl = imageUrl;
    modal.style.display = 'flex';
    modalImg.src = imageUrl;
    
    const filename = imageUrl.split('/').pop();
    caption.textContent = filename;
    
    document.body.style.overflow = 'hidden';
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

function downloadModalImage() {
    const link = document.createElement('a');
    link.href = currentImageUrl;
    link.download = currentImageUrl.split('/').pop();
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function copyModalImageUrl() {
    copyImageUrl(currentImageUrl);
}

function copyImageUrl(url) {
    const input = document.createElement('input');
    input.value = url;
    document.body.appendChild(input);
    input.select();
    
    try {
        document.execCommand('copy');
        alert('Image URL copied to clipboard!\n\n' + url);
    } catch (err) {
        navigator.clipboard.writeText(url).then(() => {
            alert('Image URL copied to clipboard!\n\n' + url);
        }).catch(() => {
            alert('Failed to copy. URL: ' + url);
        });
    }
    
    document.body.removeChild(input);
}

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeImageModal();
    }
});

function deleteSource(listingId, sourceId) {
    if (!confirm('Are you sure you want to delete this source? Pricing will be recalculated.')) {
        return;
    }
    
    console.log(`Deleting source: listing=${listingId}, source=${sourceId}`);
    
    fetch(`/listing/${listingId}/source/${sourceId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers.get('content-type'));
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response. Check server logs.');
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        
        if (data.success) {
            const card = document.getElementById(`source-${sourceId}`);
            if (card) {
                card.style.transition = 'opacity 0.3s';
                card.style.opacity = '0';
                setTimeout(() => {
                    card.remove();
                    
                    const sourcesGrid = document.querySelector('.sources-grid');
                    if (sourcesGrid && sourcesGrid.children.length === 0) {
                        location.reload();
                    }
                }, 300);
            }
            
            alert(data.message);
            setTimeout(() => location.reload(), 500);
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        alert('Error deleting source: ' + error.message);
    });
}

function deleteAllSources(listingId) {
    if (!confirm('Are you sure you want to delete ALL sources? This cannot be undone. Pricing will be cleared.')) {
        return;
    }
    
    console.log(`Deleting all sources for listing ${listingId}`);
    
    fetch(`/listing/${listingId}/sources/delete-all`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response. Check server logs.');
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Delete all error:', error);
        alert('Error deleting sources: ' + error.message);
    });
}

function startResearch(listingId) {
    const btn = document.getElementById('research-btn');
    const status = document.getElementById('research-status');

    btn.disabled = true;
    btn.textContent = 'ğŸ”„ Scraping Craigslist...';
    status.textContent = 'Please wait, this may take a minute...';

    fetch(`/listing/${listingId}/scrape-craigslist`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            status.textContent = `âœ“ Found ${data.stats.source_count || 0} similar listings! Refreshing...`;
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            status.textContent = 'âœ— Error: ' + (data.error || 'Unknown error');
            btn.disabled = false;
            btn.textContent = 'ğŸ” Start Research';
        }
    })
    .catch(error => {
        status.textContent = 'âœ— Error: ' + error.message;
        btn.disabled = false;
        btn.textContent = 'ğŸ” Start Research';
    });
}

{% if listing.status == 'researching' %}
setTimeout(() => {
    location.reload();
}, 10000);
{% endif %}

// Editable fields functionality
const listingId = {{ listing.id }};

function setupEditableField(fieldId, fieldName) {
    const field = document.getElementById(fieldId);
    if (!field) return;
    
    // Enable editing on click when readonly
    field.addEventListener('click', function() {
        if (this.readOnly) {
            this.readOnly = false;
            this.style.backgroundColor = '';
            this.style.color = '';
            this.focus();
            this.select();
        }
    });
    
    // Track changes
    field.addEventListener('input', function() {
        const originalValue = this.dataset.original;
        if (this.value !== originalValue) {
            this.classList.add('modified');
        } else {
            this.classList.remove('modified');
        }
    });
    
    // Handle keyboard events
    field.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
	    // for textarea, allow shift+enter for new lines
	    if(this.tagName === 'TEXTAREA' && event.shiftKey) {
		    // allow default behaviour (insert newline)
		    return;
	    }


            event.preventDefault();
            
            const newValue = this.value.trim();
            const originalValue = this.dataset.original;
            
            if (newValue !== originalValue) {
                // Update the listing
                updateListingField(listingId, fieldName, newValue, field);
            } else {
                // No change, just set back to readonly
                this.readOnly = true;
                this.classList.remove('modified');
            }
        } else if (event.key === 'Escape') {
            // Revert to original value
            this.value = this.dataset.original;
            this.classList.remove('modified');
            this.readOnly = true;
        }
    });
    
    // Handle blur (click outside)
    field.addEventListener('blur', function() {
        const originalValue = this.dataset.original;
        if (this.value !== originalValue && this.classList.contains('modified')) {
            // Ask user if they want to save
            if (confirm('Save changes to ' + fieldName + '?')) {
                updateListingField(listingId, fieldName, this.value.trim(), field);
            } else {
                this.value = originalValue;
                this.classList.remove('modified');
                this.readOnly = true;
            }
        } else {
            this.readOnly = true;
        }
    });
}

function updateListingField(listingId, fieldName, value, fieldElement) {
    const data = {};
    data[fieldName] = value;
    
    fetch('/listing/' + listingId + '/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update stored original value
            fieldElement.dataset.original = value;
            fieldElement.classList.remove('modified');
            fieldElement.readOnly = true;
            
            // Show success message briefly
            const originalBg = fieldElement.style.backgroundColor;
            fieldElement.style.backgroundColor = '#4caf50';
            setTimeout(function() {
                fieldElement.style.backgroundColor = originalBg;
            }, 500);
        } else {
            alert('Error updating ' + fieldName + ': ' + (data.error || 'Unknown error'));
            fieldElement.value = fieldElement.dataset.original;
            fieldElement.classList.remove('modified');
        }
    })
    .catch(error => {
        console.error('Update error:', error);
        alert('Error updating ' + fieldName + ': ' + error.message);
        fieldElement.value = fieldElement.dataset.original;
        fieldElement.classList.remove('modified');
    });
}

// Setup all editable fields
setupEditableField('statusfield', 'status');
setupEditableField('conditionfield', 'condition');
setupEditableField('measurementsfield', 'measurements');
setupEditableField('descriptionfield', 'description');

</script>

{% endblock %}
