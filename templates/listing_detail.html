{% extends "base.html" %}

{% block title %}{{ listing.title }} - Listing Details{% endblock %}

{% block content %}
<a href="{{ url_for('listings_page') }}" class="back-link">â† Back to all listings</a>

<div class="card">
    <h1>{{ listing.title }}</h1>
    
    <div class="metadata">
        <div class="meta-item">
            <div class="meta-label">Listing ID</div>
            <div class="meta-value">#{{ listing.id }}</div>
        </div>
        <div class="meta-item">
            <div class="meta-label">Status</div>
            <div class="meta-value">{{ listing.status }}</div>
        </div>
        <div class="meta-item">
            <div class="meta-label">Condition</div>
            <div class="meta-value">{{ listing.condition }}</div>
        </div>
        <div class="meta-item">
            <div class="meta-label">JIRA Issue</div>
            <div class="meta-value">
		    <a href="{{ jira_site_url }}/browse/{{ listing.jira_issue_key }}" 
                   target="_blank" class="badge badge-jira">{{ listing.jira_issue_key }}</a>
            </div>
        </div>
    </div>
    
    <div class="price-section">
        <div class="price-main">{{ listing.suggested_price|currency }}</div>
        <div class="price-range">
            Price range: {{ listing.price_min|currency }} - {{ listing.price_max|currency }}
        </div>
    </div>

    <div class="research-actions">
    {% if listing.status == 'draft' %}
    <button onclick="startResearch({{ listing.id }})" class="btn btn-primary btn-lg" id="research-btn">
        ğŸ” Start Research
    </button>
    <span id="research-status" class="text-muted"></span>
    {% elif listing.status == 'researching' %}
    <div class="alert alert-info">
        <strong>ğŸ”„ Research in progress...</strong>
        <button onclick="location.reload()" class="btn btn-sm btn-secondary">Refresh Page</button>
    </div>
    {% elif listing.status == 'ready' %}
    <div class="alert alert-success">
        âœ… Research completed! Listing is ready.
    </div>
    {% endif %}
</div>
    
    {% if listing.measurements %}
    <div class="meta-item">
        <div class="meta-label">Measurements</div>
        <div class="meta-value">{{ listing.measurements }}</div>
    </div>
    {% endif %}
    
    <h2 class="section-title">Description</h2>
    <div class="description">
        <p>{{ listing.description|replace('\n', '<br>')|safe if listing.description else 'No description available' }}</p>
    </div>
    
    {% if listing.images %}
    <h2 class="section-title">Images ({{ listing.images|length }})</h2>
    <div class="images-grid">
        {% for img_path in listing.images %}
        <div class="image-placeholder">ğŸ“· {{ img_path.split('/')[-1] }}</div>
        {% endfor %}
    </div>
    {% endif %}
    
    {% if listing.sources %}

	<h2 class="section-title">
    Research Sources ({{ listing.sources|length }})
    {% if listing.sources|length > 0 %}
    <button onclick="deleteAllSources({{ listing.id }})" class="btn btn-sm btn-danger" style="float: right;">
        ğŸ—‘ï¸ Delete All Sources
    </button>
    {% endif %}
</h2>
<div class="sources-grid">
    {% for source in listing.sources %}
    <div class="source-card" id="source-{{ source.id }}">
        {% if source.image_url %}
        <div class="source-image">
            <img src="{{ source.image_url }}" 
                 alt="{{ source.title }}" 
                 loading="lazy"
                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'200\' viewBox=\'0 0 300 200\'%3E%3Crect fill=\'%23f0f0f0\' width=\'300\' height=\'200\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' font-family=\'monospace\' font-size=\'16\' fill=\'%23999\'%3ENo Image%3C/text%3E%3C/svg%3E';">
            <button onclick="deleteSource({{ listing.id }}, {{ source.id }})" 
                    class="source-delete-btn" 
                    title="Delete this source">
                âœ•
            </button>
        </div>
        {% else %}
        <div class="source-image source-no-image">
            <span>ğŸ“· No Image</span>
            <button onclick="deleteSource({{ listing.id }}, {{ source.id }})" 
                    class="source-delete-btn" 
                    title="Delete this source">
                âœ•
            </button>
        </div>
        {% endif %}
        
        <div class="source-content">
            <h4 class="source-title">
                <a href="{{ source.url }}" target="_blank" rel="noopener">
                    {{ source.title }}
                </a>
            </h4>
            
            <div class="source-meta">
                {% if source.price %}
                <div class="source-price">${{ "%.2f"|format(source.price) }}</div>
                {% else %}
                <div class="source-price text-muted">Price not listed</div>
                {% endif %}
                
                {% if source.location %}
                <div class="source-location">ğŸ“ {{ source.location }}</div>
                {% endif %}
                
                {% if source.condition %}
                <div class="source-condition">
                    <span class="badge badge-secondary">{{ source.condition }}</span>
                </div>
                {% endif %}
            </div>
            
            {% if source.measurements %}
            <div class="source-measurements">
                ğŸ“ {{ source.measurements }}
            </div>
            {% endif %}
            
            {% if source.description %}
            <div class="source-description">
                {{ source.description[:200] }}{% if source.description|length > 200 %}...{% endif %}
            </div>
            {% endif %}
            
            <div class="source-footer">
                <small class="text-muted">
                    Posted: {{ source.posted_date or 'Unknown' }}
                </small>
                <a href="{{ source.url }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline-primary">
                    View on Craigslist â†’
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <p>No research sources found yet.</p>
</div>

    {% endif %}
    
    <h2 class="section-title">Timeline</h2>
    <div class="metadata">
        <div class="meta-item">
            <div class="meta-label">Created</div>
            <div class="meta-value">{{ listing.created_at|datetime }}</div>
        </div>
        <div class="meta-item">
            <div class="meta-label">Last Updated</div>
            <div class="meta-value">{{ listing.updated_at|datetime }}</div>
        </div>
        {% if listing.listed_at %}
        <div class="meta-item">
            <div class="meta-label">Listed</div>
            <div class="meta-value">{{ listing.listed_at|datetime }}</div>
        </div>
        {% endif %}
        {% if listing.sold_at %}
        <div class="meta-item">
            <div class="meta-label">Sold</div>
            <div class="meta-value">{{ listing.sold_at|datetime }}</div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function deleteSource(listingId, sourceId) {
    if (!confirm('Are you sure you want to delete this source? Pricing will be recalculated.')) {
        return;
    }
    
    console.log(`Deleting source: listing=${listingId}, source=${sourceId}`);
    
    fetch(`/listing/${listingId}/source/${sourceId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers.get('content-type'));
        
        // Check if response is actually JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response. Check server logs.');
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        
        if (data.success) {
            // Remove the card from the DOM
            const card = document.getElementById(`source-${sourceId}`);
            if (card) {
                card.style.transition = 'opacity 0.3s';
                card.style.opacity = '0';
                setTimeout(() => {
                    card.remove();
                    
                    // Check if no more sources
                    const sourcesGrid = document.querySelector('.sources-grid');
                    if (sourcesGrid && sourcesGrid.children.length === 0) {
                        location.reload(); // Reload to show updated pricing
                    }
                }, 300);
            }
            
            // Show success message
            alert(data.message);
            
            // Reload page to update pricing display
            setTimeout(() => location.reload(), 500);
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Delete error:', error);
        alert('Error deleting source: ' + error.message);
    });
}

function deleteAllSources(listingId) {
    if (!confirm('Are you sure you want to delete ALL sources? This cannot be undone. Pricing will be cleared.')) {
        return;
    }
    
    console.log(`Deleting all sources for listing ${listingId}`);
    
    fetch(`/listing/${listingId}/sources/delete-all`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Server returned non-JSON response. Check server logs.');
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Delete all error:', error);
        alert('Error deleting sources: ' + error.message);
    });
}

function startResearch(listingId) {
    const btn = document.getElementById('research-btn');
    const status = document.getElementById('research-status');

    btn.disabled = true;
    btn.textContent = 'ğŸ”„ Scraping Craigslist...';
    status.textContent = 'Please wait, this may take a minute...';

    fetch(`/listing/${listingId}/scrape-craigslist`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            status.textContent = `âœ“ Found ${data.stats.source_count || 0} similar listings! Refreshing...`;
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            status.textContent = 'âœ— Error: ' + (data.error || 'Unknown error');
            btn.disabled = false;
            btn.textContent = 'ğŸ” Start Research';
        }
    })
    .catch(error => {
        status.textContent = 'âœ— Error: ' + error.message;
        btn.disabled = false;
        btn.textContent = 'ğŸ” Start Research';
    });
}

// Auto-refresh if status is researching
{% if listing.status == 'researching' %}
setTimeout(() => {
    location.reload();
}, 10000); // Refresh every 10 seconds
{% endif %}
</script>

{% endblock %}
